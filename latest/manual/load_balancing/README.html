


<!doctype html>
<html class="no-js" lang="en">
  
<head><!-- begin head.html -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>
    Load balancing | Scylla Docs
    </title>
    <meta name="description" content="Scylla is an Apache Cassandra-compatible NoSQL data store that can handle 1 million transactions per second on a single server." />

    <link rel="icon" href="../../_static/img/favicon.ico" type="image/x-icon"/>
    <link rel="canonical" href="https://docs.scylladb.com/">

    <link rel="author" href="mailto:info@scylladb.com">
    <link rel="stylesheet" href="../../_static/" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx_tabs/semantic-ui-2.4.1/segment.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx_tabs/semantic-ui-2.4.1/menu.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx_tabs/tabs.css" />
    
    <link href='https://fonts.googleapis.com/css?family=Roboto:400,100,300,500,700' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.5.2/css/foundation.min.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/doc/main.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>

    <script src="../../_static/js/vendor/modernizr.js"></script>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-T8P2JP');</script>
    <!-- End Google Tag Manager -->

    <!-- Marketo -->
    <script type="text/javascript"> (function() { var didInit = false; function initMunchkin() { if(didInit === false) { didInit = true; Munchkin.init('791-QBF-350'); } } var s = document.createElement('script'); s.type = 'text/javascript'; s.async = true; s.src = '//munchkin.marketo.net/munchkin.js'; s.onreadystatechange = function() { if (this.readyState == 'complete' || this.readyState == 'loaded') { initMunchkin(); } }; s.onload = initMunchkin; document.getElementsByTagName('head')[0].appendChild(s); })(); </script>
    <!-- End Marketo -->

<!-- end head.html -->
</head>

<body>
<header id="header" class="animated">
    <div class="topbar_continer contain-to-grid clearfix">
        <nav class="top-bar" id="top-bar" data-topbar role="navigation">
            <ul class="title-area">
                <li class="name">
                    <div class="logo">
                        <a href="https://docs.scylladb.com/"><img src="../../_static/img/logo-scylla-docs.svg" alt="" width="151"></a>
                    </div>
                </li>
                <li class="toggle-topbar"><a href="#"><span class="icon-manu"></span></a></li>
            </ul>
            <section class="top-bar-section clearfix">
                <ul class="right">
                    
                    <li>
                        <a href="https://scylladb.github.io/java-driver/">Scylla Java Driver</a>
                    </li>
                    
                    <li>
                        <a href="https://docs.scylladb.com/scylla-cloud/">Scylla Cloud</a>
                    </li>
                    
                    <li>
                        <a href="https://university.scylladb.com/">Scylla University</a>
                    </li>
                    
                    <li>
                        <a href="https://www.scylladb.com/">ScyllaDB Home</a>
                    </li>
                    
                    <li class="search_continer show-for-medium-up">	
                        <ci-search></ci-search>	
                    </li>	
                </ul>
            </section>
        </nav>
    </div>
</header>
<section id="content">
    <div class="row">
	
	<div class="large-6 large-push-3 columns">
            <div class="section" id="load-balancing">
<h1>Load balancing<a class="headerlink" href="#load-balancing" title="Permalink to this headline">¶</a></h1>
<p>A Cassandra cluster is typically composed of multiple hosts; the <a class="reference external" href="https://docs.datastax.com/en/drivers/java/3.10/com/datastax/driver/core/policies/LoadBalancingPolicy.html">LoadBalancingPolicy</a> (sometimes abbreviated LBP) is a
central component that determines:</p>
<ul class="simple">
<li><p>which hosts the driver will communicate with;</p></li>
<li><p>for each new query, which coordinator to pick, and which hosts to use as failover.</p></li>
</ul>
<p>The policy is configured when initializing the cluster:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">Cluster</span> <span class="n">cluster</span> <span class="o">=</span> <span class="n">Cluster</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">addContactPoint</span><span class="o">(</span><span class="s">&quot;127.0.0.1&quot;</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withLoadBalancingPolicy</span><span class="o">(</span><span class="k">new</span> <span class="n">RoundRobinPolicy</span><span class="o">())</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</pre></div>
</div>
<p>Once the cluster has been built, you can’t change the policy, but you may inspect it at runtime:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">LoadBalancingPolicy</span> <span class="n">lbp</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="na">getConfiguration</span><span class="o">().</span><span class="na">getPolicies</span><span class="o">().</span><span class="na">getLoadBalancingPolicy</span><span class="o">();</span>
</pre></div>
</div>
<p>If you don’t explicitly configure the policy, you get the default, which is a
<a class="reference external" href="#dc-aware-round-robin-policy">datacenter-aware</a>, <a class="reference external" href="#token-aware-policy">token-aware</a> policy:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="k">new</span> <span class="n">TokenAwarePolicy</span><span class="o">(</span><span class="n">DCAwareRoundRobinPolicy</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">build</span><span class="o">());</span>
</pre></div>
</div>
<div class="section" id="common-concepts">
<h2>Common concepts<a class="headerlink" href="#common-concepts" title="Permalink to this headline">¶</a></h2>
<p>Before we review the available implementations, we need to introduce two concepts:</p>
<div class="section" id="host-distance">
<h3>Host distance<a class="headerlink" href="#host-distance" title="Permalink to this headline">¶</a></h3>
<p>For each host, the policy computes a <strong><a class="reference external" href="https://docs.datastax.com/en/drivers/java/3.10/com/datastax/driver/core/HostDistance.html">distance</a></strong> that determines how the driver will establish connections
to it:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">LOCAL</span></code> and <code class="docutils literal notranslate"><span class="pre">REMOTE</span></code> are “active” distances, meaning that the driver will keep open connections to the host. They
differ in the number of connections opened, depending on your <a class="reference external" href="../pooling/">pooling options</a>. Also, the
<a class="reference external" href="../control_connection/">control connection</a> will  favor local nodes if possible.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IGNORED</span></code>, as the name suggests, means that the driver will not attempt to connect.</p></li>
</ul>
<p>Typically, the distance will reflect network topology (e.g. local vs. remote datacenter), although that is entirely up
to your policy. The distance can be dynamic: the driver re-checks it whenever connection pools are created (e.g. at
startup or if a node was down and just came back up); you can also trigger it with <a class="reference external" href="https://docs.datastax.com/en/drivers/java/3.10/com/datastax/driver/core/PoolingOptions.html#refreshConnectedHosts--">refreshConnectedHosts</a>:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// Re-evaluate all host distances:</span>
<span class="n">cluster</span><span class="o">.</span><span class="na">getConfiguration</span><span class="o">().</span><span class="na">getPoolingOptions</span><span class="o">().</span><span class="na">refreshConnectedHosts</span><span class="o">();</span>

<span class="c1">// Re-evaluate the distance for a given host:</span>
<span class="n">cluster</span><span class="o">.</span><span class="na">getConfiguration</span><span class="o">().</span><span class="na">getPoolingOptions</span><span class="o">().</span><span class="na">refreshConnectedHost</span><span class="o">(</span><span class="n">host</span><span class="o">);</span>
</pre></div>
</div>
</div>
<div class="section" id="query-plan">
<h3>Query plan<a class="headerlink" href="#query-plan" title="Permalink to this headline">¶</a></h3>
<p>Each time the driver executes a query, it asks the policy to compute a <strong>query plan</strong>, which is a list of hosts. The
driver will then try each host in sequence, according to the <a class="reference external" href="../retries/">retry policy</a> and
<a class="reference external" href="../speculative_execution">speculative execution policy</a>.</p>
<p>The contents and order of query plans are entirely up to your policy, but implementations typically return plans that:</p>
<ul class="simple">
<li><p>are different for each query, in order to balance the load across the cluster;</p></li>
<li><p>only contain hosts that are known to be able to process queries, i.e. neither ignored nor down;</p></li>
<li><p>favor local hosts over remote ones.</p></li>
</ul>
<p>The next sections describe the implementations that are provided with the driver.</p>
</div>
</div>
<div class="section" id="roundrobinpolicy">
<h2><a class="reference external" href="https://docs.datastax.com/en/drivers/java/3.10/com/datastax/driver/core/policies/RoundRobinPolicy.html">RoundRobinPolicy</a><a class="headerlink" href="#roundrobinpolicy" title="Permalink to this headline">¶</a></h2>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">Cluster</span> <span class="n">cluster</span> <span class="o">=</span> <span class="n">Cluster</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">addContactPoint</span><span class="o">(</span><span class="s">&quot;127.0.0.1&quot;</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withLoadBalancingPolicy</span><span class="o">(</span><span class="k">new</span> <span class="n">RoundRobinPolicy</span><span class="o">())</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</pre></div>
</div>
<p>This is the most straightforward implementation. It returns query plans that include all hosts, and shift for each
query in a round-robin fashion. For example:</p>
<ul class="simple">
<li><p>query 1: host1, host2, host3</p></li>
<li><p>query 2: host2, host3, host1</p></li>
<li><p>query 3: host3, host1, host2</p></li>
<li><p>query 4: host1, host2, host3</p></li>
<li><p>etc.</p></li>
</ul>
<p>All hosts are at distance <code class="docutils literal notranslate"><span class="pre">LOCAL</span></code>.</p>
<p>This works well for simple deployments. If you have multiple datacenters, it will be inefficient and you probably want
to switch to a DC-aware policy.</p>
</div>
<div class="section" id="dcawareroundrobinpolicy">
<h2><a class="reference external" href="https://docs.datastax.com/en/drivers/java/3.10/com/datastax/driver/core/policies/DCAwareRoundRobinPolicy.html">DCAwareRoundRobinPolicy</a><a class="headerlink" href="#dcawareroundrobinpolicy" title="Permalink to this headline">¶</a></h2>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">Cluster</span> <span class="n">cluster</span> <span class="o">=</span> <span class="n">Cluster</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">addContactPoint</span><span class="o">(</span><span class="s">&quot;127.0.0.1&quot;</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withLoadBalancingPolicy</span><span class="o">(</span>
                <span class="n">DCAwareRoundRobinPolicy</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">withLocalDc</span><span class="o">(</span><span class="s">&quot;myLocalDC&quot;</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">build</span><span class="o">()</span>
        <span class="o">).</span><span class="na">build</span><span class="o">();</span>
</pre></div>
</div>
<p>This policy queries nodes of the local data-center in a round-robin fashion.</p>
<p>Call <code class="docutils literal notranslate"><span class="pre">withLocalDc</span></code> to specify the name of your local datacenter. You can also leave it out, and the driver will use the
datacenter of the first contact point that was reached <a class="reference external" href="../#cluster-initialization">at initialization</a>. However,
remember that the driver shuffles the initial list of contact points, so this assumes that all contact points are in the
local datacenter. In general, providing the datacenter name explicitly is a safer option.</p>
<p>Hosts belonging to the local datacenter are at distance <code class="docutils literal notranslate"><span class="pre">LOCAL</span></code>, and appear first in query plans (in a round-robin
fashion).</p>
</div>
<div class="section" id="tokenawarepolicy">
<h2><a class="reference external" href="https://docs.datastax.com/en/drivers/java/3.10/com/datastax/driver/core/policies/TokenAwarePolicy.html">TokenAwarePolicy</a><a class="headerlink" href="#tokenawarepolicy" title="Permalink to this headline">¶</a></h2>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">Cluster</span> <span class="n">cluster</span> <span class="o">=</span> <span class="n">Cluster</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">addContactPoint</span><span class="o">(</span><span class="s">&quot;127.0.0.1&quot;</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withLoadBalancingPolicy</span><span class="o">(</span><span class="k">new</span> <span class="n">TokenAwarePolicy</span><span class="o">(</span><span class="n">anotherPolicy</span><span class="o">))</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</pre></div>
</div>
<p>This policy adds <strong>token awareness</strong> on top of another policy: requests will be routed in priority to the local replicas
that own the data that is being queried.</p>
<div class="section" id="requirements">
<h3>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h3>
<p>In order for token awareness to work, you should first ensure that metadata is enabled in the driver. That is the case
by default, unless it’s been explicitly disabled by <a class="reference external" href="https://docs.datastax.com/en/drivers/java/3.10/com/datastax/driver/core/QueryOptions.html#setMetadataEnabled-boolean-">QueryOptions#setMetadataEnabled</a>.</p>
<p>Then you need to consider whether routing information (provided by <a class="reference external" href="https://docs.datastax.com/en/drivers/java/3.10/com/datastax/driver/core/Statement.html#getKeyspace--">Statement#getKeyspace</a> and
<a class="reference external" href="https://docs.datastax.com/en/drivers/java/3.10/com/datastax/driver/core/Statement.html#getRoutingKey--">Statement#getRoutingKey</a>) can be computed automatically for your statements; if not, you may provide it yourself (if a
statement has no routing information, the query will still be executed, but token awareness will not work, so the driver
might not pick the best coordinator).</p>
<p>The examples assume the following CQL schema:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">testKs</span><span class="o">.</span><span class="n">sensor_data</span><span class="p">(</span><span class="nb">id</span> <span class="nb">int</span><span class="p">,</span> <span class="n">year</span> <span class="nb">int</span><span class="p">,</span> <span class="n">ts</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">data</span> <span class="n">double</span><span class="p">,</span>
                                <span class="n">PRIMARY</span> <span class="n">KEY</span> <span class="p">((</span><span class="nb">id</span><span class="p">,</span> <span class="n">year</span><span class="p">),</span> <span class="n">ts</span><span class="p">));</span>
</pre></div>
</div>
<p>For <a class="reference external" href="../statements/simple/">simple statements</a>, routing information can never be computed automatically:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">SimpleStatement</span> <span class="n">statement</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleStatement</span><span class="o">(</span>
        <span class="s">&quot;SELECT * FROM testKs.sensor_data WHERE id = 1 and year = 2016&quot;</span><span class="o">);</span>

<span class="c1">// No routing info available:</span>
<span class="k">assert</span> <span class="n">statement</span><span class="o">.</span><span class="na">getKeyspace</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">;</span>
<span class="k">assert</span> <span class="n">statement</span><span class="o">.</span><span class="na">getRoutingKey</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">;</span>

<span class="c1">// Set the keyspace manually:</span>
<span class="n">statement</span><span class="o">.</span><span class="na">setKeyspace</span><span class="o">(</span><span class="s">&quot;testKs&quot;</span><span class="o">);</span>

<span class="c1">// Set the routing key manually: serialize each partition key component to its target CQL type</span>
<span class="n">ProtocolVersion</span> <span class="n">protocolVersion</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="na">getConfiguration</span><span class="o">().</span><span class="na">getProtocolOptions</span><span class="o">().</span><span class="na">getProtocolVersionEnum</span><span class="o">();</span>
<span class="n">statement</span><span class="o">.</span><span class="na">setRoutingKey</span><span class="o">(</span>
        <span class="n">TypeCodec</span><span class="o">.</span><span class="na">cint</span><span class="o">().</span><span class="na">serialize</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">protocolVersion</span><span class="o">),</span>
        <span class="n">TypeCodec</span><span class="o">.</span><span class="na">cint</span><span class="o">().</span><span class="na">serialize</span><span class="o">(</span><span class="mi">2016</span><span class="o">,</span> <span class="n">protocolVersion</span><span class="o">));</span>

<span class="n">session</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">statement</span><span class="o">);</span>
</pre></div>
</div>
<p>For <a class="reference external" href="../statements/built/">built statements</a>, the keyspace is available if it was provided while building the query; the
routing key is available only if the statement was built using the table metadata, and all components of the partition
key appear in the query:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">TableMetadata</span> <span class="n">tableMetadata</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">()</span>
        <span class="o">.</span><span class="na">getKeyspace</span><span class="o">(</span><span class="s">&quot;testKs&quot;</span><span class="o">)</span>
        <span class="o">.</span><span class="na">getTable</span><span class="o">(</span><span class="s">&quot;sensor_data&quot;</span><span class="o">);</span>

<span class="c1">// Built from metadata: all info available</span>
<span class="n">BuiltStatement</span> <span class="n">statement1</span> <span class="o">=</span> <span class="n">select</span><span class="o">().</span><span class="na">from</span><span class="o">(</span><span class="n">tableMetadata</span><span class="o">)</span>
        <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">eq</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">,</span> <span class="mi">1</span><span class="o">))</span>
        <span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">eq</span><span class="o">(</span><span class="s">&quot;year&quot;</span><span class="o">,</span> <span class="mi">2016</span><span class="o">));</span>

<span class="k">assert</span> <span class="n">statement1</span><span class="o">.</span><span class="na">getKeyspace</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
<span class="k">assert</span> <span class="n">statement1</span><span class="o">.</span><span class="na">getRoutingKey</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>

<span class="c1">// Built from keyspace and table name: only keyspace available</span>
<span class="n">BuiltStatement</span> <span class="n">statement2</span> <span class="o">=</span> <span class="n">select</span><span class="o">().</span><span class="na">from</span><span class="o">(</span><span class="s">&quot;testKs&quot;</span><span class="o">,</span> <span class="s">&quot;sensor&quot;</span><span class="o">)</span>
        <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">eq</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">,</span> <span class="mi">1</span><span class="o">))</span>
        <span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">eq</span><span class="o">(</span><span class="s">&quot;year&quot;</span><span class="o">,</span> <span class="mi">2016</span><span class="o">));</span>

<span class="k">assert</span> <span class="n">statement2</span><span class="o">.</span><span class="na">getKeyspace</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
<span class="k">assert</span> <span class="n">statement2</span><span class="o">.</span><span class="na">getRoutingKey</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">;</span>
</pre></div>
</div>
<p>For <a class="reference external" href="../statements/prepared/">bound statements</a>, the keyspace is always available; the routing key is only available if
all components of the partition key are bound as variables:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// All components bound: all info available</span>
<span class="n">PreparedStatement</span> <span class="n">pst1</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">prepare</span><span class="o">(</span><span class="s">&quot;SELECT * FROM testKs.sensor_data WHERE id = :id and year = :year&quot;</span><span class="o">);</span>
<span class="n">BoundStatement</span> <span class="n">statement1</span> <span class="o">=</span> <span class="n">pst1</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2016</span><span class="o">);</span>

<span class="k">assert</span> <span class="n">statement1</span><span class="o">.</span><span class="na">getKeyspace</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
<span class="k">assert</span> <span class="n">statement1</span><span class="o">.</span><span class="na">getRoutingKey</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>

<span class="c1">// &#39;id&#39; hard-coded, only &#39;year&#39; is bound: only keyspace available</span>
<span class="n">PreparedStatement</span> <span class="n">pst2</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">prepare</span><span class="o">(</span><span class="s">&quot;SELECT * FROM testKs.sensor_data WHERE id = 1 and year = :year&quot;</span><span class="o">);</span>
<span class="n">BoundStatement</span> <span class="n">statement2</span> <span class="o">=</span> <span class="n">pst2</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="mi">2016</span><span class="o">);</span>

<span class="k">assert</span> <span class="n">statement2</span><span class="o">.</span><span class="na">getKeyspace</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
<span class="k">assert</span> <span class="n">statement2</span><span class="o">.</span><span class="na">getRoutingKey</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">;</span>
</pre></div>
</div>
<p>For <a class="reference external" href="../statements/batch/">batch statements</a>, the routing information of each child statement is inspected; the first
non-null keyspace is used as the keyspace of the batch, and the first non-null routing key as its routing key (the idea
is that all childs should have the same routing information, since batches are supposed to operate on a single
partition). All children might have null information, in which case you need to provide the information manually as
shown previously.</p>
</div>
<div class="section" id="behavior">
<h3>Behavior<a class="headerlink" href="#behavior" title="Permalink to this headline">¶</a></h3>
<p>For any host, the distance returned by <code class="docutils literal notranslate"><span class="pre">TokenAwarePolicy</span></code> is always the same as its child policy.</p>
<p>When the policy computes a query plan, it will first inspect the statement’s routing information. If there is none, the
policy simply acts as a pass-through, and returns the query plan computed by its child policy.</p>
<p>If the statement has routing information, the policy uses it to determine the replicas that hold the corresponding data.
Then it returns a query plan containing:</p>
<ol class="simple">
<li><p>the replicas for which the child policy returns distance <code class="docutils literal notranslate"><span class="pre">LOCAL</span></code>, shuffled in a random order;</p></li>
<li><p>followed by the query plan of the child policy, skipping any host that were already returned by the previous step.</p></li>
</ol>
<p>Finally, the <code class="docutils literal notranslate"><span class="pre">shuffleReplicas</span></code> constructor parameter allows you to control whether the policy shuffles the replicas in
step 1:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="k">new</span> <span class="n">TokenAwarePolicy</span><span class="o">(</span><span class="n">anotherPolicy</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span> <span class="c1">// no shuffling</span>
</pre></div>
</div>
<p>Shuffling will distribute writes better, and can alleviate hotspots caused by “fat” partitions. On the other hand,
setting it to <code class="docutils literal notranslate"><span class="pre">false</span></code> might increase the effectiveness of caching, since data will always be retrieved from the
“primary” replica. Shuffling is enabled by default.</p>
</div>
</div>
<div class="section" id="latencyawarepolicy">
<h2><a class="reference external" href="https://docs.datastax.com/en/drivers/java/3.10/com/datastax/driver/core/policies/LatencyAwarePolicy.html">LatencyAwarePolicy</a><a class="headerlink" href="#latencyawarepolicy" title="Permalink to this headline">¶</a></h2>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">Cluster</span> <span class="n">cluster</span> <span class="o">=</span> <span class="n">Cluster</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">addContactPoint</span><span class="o">(</span><span class="s">&quot;127.0.0.1&quot;</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withLoadBalancingPolicy</span><span class="o">(</span>
                <span class="n">LatencyAwarePolicy</span><span class="o">.</span><span class="na">builder</span><span class="o">(</span><span class="n">anotherPolicy</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">withExclusionThreshold</span><span class="o">(</span><span class="mf">2.0</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">withScale</span><span class="o">(</span><span class="mi">100</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">withRetryPeriod</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">withUpdateRate</span><span class="o">(</span><span class="mi">100</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">withMininumMeasurements</span><span class="o">(</span><span class="mi">50</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">build</span><span class="o">()</span>
        <span class="o">).</span><span class="na">build</span><span class="o">();</span>
</pre></div>
</div>
<p>This policy adds <strong>latency awareness</strong> on top of another policy: it collects the latencies of queries to each host, and
will exclude the worst-performing hosts from query plans.</p>
<p>The builder allow you to customize various aspects of the policy:</p>
<ul class="simple">
<li><p>the <a class="reference external" href="https://docs.datastax.com/en/drivers/java/3.10/com/datastax/driver/core/policies/LatencyAwarePolicy.Builder.html#withExclusionThreshold-double-">exclusion threshold</a> controls how much worse a host must perform (compared to the fastest
host) in order to be excluded. For example, 2 means that hosts that are twice slower will be excluded;</p></li>
<li><p>since a host’s performance can vary over time, its score is computed with a time-weighted average; the
<a class="reference external" href="https://docs.datastax.com/en/drivers/java/3.10/com/datastax/driver/core/policies/LatencyAwarePolicy.Builder.html#withScale-long-java.util.concurrent.TimeUnit-">scale</a> controls how fast the weight given to older latencies decreases over time;</p></li>
<li><p>the <a class="reference external" href="https://docs.datastax.com/en/drivers/java/3.10/com/datastax/driver/core/policies/LatencyAwarePolicy.Builder.html#withRetryPeriod-long-java.util.concurrent.TimeUnit-">retry period</a> is the duration for which a slow host will be penalized;</p></li>
<li><p>the <a class="reference external" href="https://docs.datastax.com/en/drivers/java/3.10/com/datastax/driver/core/policies/LatencyAwarePolicy.Builder.html#withUpdateRate-long-java.util.concurrent.TimeUnit-">update rate</a> defines how often the minimum average latency (i.e. the fastest host) is recomputed;</p></li>
<li><p>the <a class="reference external" href="https://docs.datastax.com/en/drivers/java/3.10/com/datastax/driver/core/policies/LatencyAwarePolicy.Builder.html#withMininumMeasurements-int-">minimum measurements</a> threshold guarantees that we have enough measurements before we
start excluding a host. This prevents skewing the measurements during a node restart, where JVM warm-up will influence
latencies.</p></li>
</ul>
<p>For any host, the distance returned by the policy is always the same as its child policy.</p>
<p>Query plans are based on the child policy’s, except that hosts that are currently excluded for being too slow are moved
to the end of the plan.</p>
</div>
<div class="section" id="filtering-policies">
<h2>Filtering policies<a class="headerlink" href="#filtering-policies" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://docs.datastax.com/en/drivers/java/3.10/com/datastax/driver/core/policies/WhiteListPolicy.html">WhiteListPolicy</a> wraps another policy with a white list, to ensure that the driver will only ever connect to a
pre-defined subset of the cluster. The distance will be that of the child policy for hosts that are in the white list,
and <code class="docutils literal notranslate"><span class="pre">IGNORED</span></code> otherwise. Query plans are guaranteed to only contain white-listed hosts.</p>
<p><a class="reference external" href="https://docs.datastax.com/en/drivers/java/3.10/com/datastax/driver/core/policies/HostFilterPolicy.html">HostFilterPolicy</a> is a generalization of that concept, where you provide the predicate that will determine if a host is
included or not.</p>
</div>
<div class="section" id="implementing-your-own">
<h2>Implementing your own<a class="headerlink" href="#implementing-your-own" title="Permalink to this headline">¶</a></h2>
<p>If none of the provided policies fit your use case, you can write your own. This is an advanced topic, so we recommend
studying the existing implementations first: <code class="docutils literal notranslate"><span class="pre">RoundRobinPolicy</span></code> is a good place to start, then you can look at more
complex ones like <code class="docutils literal notranslate"><span class="pre">DCAwareRoundRobinPolicy</span></code>.</p>
</div>
</div>

        </div>

        <div id="sidebar" class="large-3 large-pull-6 columns"><div class="side-nav">
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../README.html">Manual</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../address_resolution/README.html">Address resolution</a></li>
<li class="toctree-l2"><a class="reference internal" href="../async/README.html">Asynchronous programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="../auth/README.html">Authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cloud/README.html">Connecting to Apollo (Cloud)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../compression/README.html">Compression</a></li>
<li class="toctree-l2"><a class="reference internal" href="../control_connection/README.html">Control connection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../custom_codecs/README.html">Custom Codecs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../custom_payloads/README.html">Custom Payloads</a></li>
<li class="toctree-l2"><a class="reference internal" href="../idempotence/README.html">Query idempotence</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Load balancing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging/README.html">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metadata/README.html">Metadata</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metrics/README.html">Metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../native_protocol/README.html">Native protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="../object_mapper/README.html">Object Mapper</a></li>
<li class="toctree-l2"><a class="reference internal" href="../osgi/README.html">OSGi</a></li>
<li class="toctree-l2"><a class="reference internal" href="../paging/README.html">Paging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pooling/README.html">Connection pooling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../query_timestamps/README.html">Query timestamps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reconnection/README.html">Reconnection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../retries/README.html">Retries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shaded_jar/README.html">Using the shaded JAR</a></li>
<li class="toctree-l2"><a class="reference internal" href="../socket_options/README.html">Socket options</a></li>
<li class="toctree-l2"><a class="reference internal" href="../speculative_execution/README.html">Speculative query execution</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ssl/README.html">SSL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../statements/README.html">Statements</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tuples/README.html">Using Tuples with the Java driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../udts/README.html">User-defined types</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../upgrade_guide/README.html">Upgrade guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/README.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog/README.html">Changelog</a></li>
</ul>

</div>
        </div>

        <div class="large-3 columns">
            
        </div>

    </div>
</section>

<!-- newsleter modal -->

<div id="newsletter_signup" class="reveal-modal tiny radius dark_modal" data-reveal aria-labelledby="modalTitle" aria-hidden="true" role="dialog">
    <a class="close-reveal-modal" aria-label="Close">×</a>
    <h2 id="modalTitle">Sign up for the Scylla newsletter</h2>
    <div id="mc_embed_signup">
        <form action="//cloudius-systems.us10.list-manage.com/subscribe/post?u=df8bb543c68230d5f7b4dcf78&amp;id=9a4589f144" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate="">
            <div id="mc_embed_signup_scroll">

                <div class="mc-field-group">
                    <div class="row collapse">
                        <div class="small-3 columns"><label for="mce-EMAIL">Email</label></div>
                        <div class="small-9 columns"><input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL"></div>
                    </div>
                </div>
                <div class="mc-field-group">
                    <div class="row collapse">
                        <div class="small-3 columns"><label for="mce-FNAME">First Name </label></div>
                        <div class="small-9 columns"><input type="text" value="" name="FNAME" class="" id="mce-FNAME"></div>
                    </div>
                </div>
                <div class="mc-field-group">
                    <div class="row collapse">
                        <div class="small-3 columns"><label for="mce-LNAME">Last Name </label></div>
                        <div class="small-9 columns"><input type="text" value="" name="LNAME" class="" id="mce-LNAME"></div>
                    </div>
                </div>
                <div id="mce-responses" class="clear">
                    <div class="response" id="mce-error-response" style="display:none"></div>
                    <div class="response" id="mce-success-response" style="display:none"></div>
                </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
                <div style="position: absolute; left: -5000px;"><input type="text" name="b_df8bb543c68230d5f7b4dcf78_9a4589f144" tabindex="-1" value=""></div>
                <div class="clear"><input type="submit" class="button" value="Sign up" name="subscribe" id="mc-embedded-subscribe"></div>
            </div>
        </form>
    </div>
</div>

<!-- end newsleter modal -->



<!-- footer.html -->
<footer id="footer">
    <div class="footer-top">
        <a class="logo" href="https://www.scylladb.com"><img src="../../_static/img/logo-scylla-horizontal-RGB.svg" alt=""></a>
        <div class="footer-links">
            <a class="link" href="https://docs.scylladb.com">Docs</a>
            <a class="link" href="https://www.scylladb.com/company/contact-us/">Contact Us</a>
            <a class="link" href="https://www.scylladb.com/company/">About Us</a>
            <a class="link button" href="https://github.com/scylladb/java-driver/issues/new?title=Issue in page Load balancing&&body=I%20would%20like%20to%20report%20an%20issue%20in%20page%20http://docs.scylladb.com/manual/load_balancing/README%0A%0A%23%23%23%20Problem%0A%0A%23%23%23%20%20Suggest%20a%20fix" target="_blank">
                Report an issue on this page</a>
        </div>
        <div class="footer-actions">
            <a class="link-icon" href="https://github.com/ScyllaDB" target="_blank">
                <span class="icon-github2"></span></a>
            <a class="link-icon" href="https://twitter.com/ScyllaDB" target="_blank">
                <span class="icon-twitter"></span></a>
            <a class="link-icon" href="https://www.linkedin.com/company/scylladb"  target="_blank">
                <span class="icon-linkedin2"></span></a>
            <a class="link-icon" href="https://www.facebook.com/scylladb/" target="_blank">
                <span class="icon-facebook"></span></a>
        </div>
    </div>

    <div class="footer-bottom">
        <div class="footer-info">
            <div class="footer-copyright">
                &#169; 2012, ScyllaDB. All rights reserved.
            </div>
            <div class="footer-last-updated">
                Last updated on 20 October 2020.
            </div>
        </div>
        <div class="footer-links">
        </div>
    </div>
</footer>
<!-- end footer.html -->

<!-- bodyscripts.html -->
<!-- at the end of the BODY --> 
<script src="../../_static/js/vendor/jquery.js"></script>
<script src="../../_static/expertrec.js"></script>
<script src="../../_static/js/foundation/foundation.js"></script>
<script src="../../_static/js/foundation/foundation.topbar.js"></script>
<script src="../../_static/app.js"></script>
<script>
    $(document).foundation();
</script>
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T8P2JP"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->

  <!-- end bodyscripts.html -->
</body>
</html>